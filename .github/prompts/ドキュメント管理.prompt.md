---
mode: edit
---

# ドキュメント管理プロンプト

このプロンプトを実行するたびに、変更内容を分析し、必要なドキュメントを生成 / 更新 / 追記してください。
参照指示書:

- `.copilot-document-instructions.md`
- `.copilot-codeGeneration-instructions.md`
- `.copilot-commit-message-instructions.md`
- `.copilot-task-instructions.md`

## 1. 入力（必ず最初に整理）

- 対象タスク ID / プロンプトファイル名:
- 関連差分 (要約 / 通知された変更点):
- 影響範囲 (機能 / コンポーネント / DB / API / テスト):
- 未確定事項 (あれば列挙):

## 2. ドキュメント種別の判定

次から必要なもののみ生成（複数可）

- [ ] 機能仕様（Feature Spec）
- [ ] アーキテクチャ決定記録（ADR）
- [ ] コンポーネント技術ドキュメント
- [ ] Server Action / API 仕様
- [ ] データベーススキーマ更新（Drizzle + Supabase 差分）
- [ ] バリデーション / フォーム（Conform + Zod）
- [ ] テスト計画 / 追加テストケース
- [ ] パフォーマンス / セキュリティ観点メモ
- [ ] リリースノート候補
- [ ] タスクリスト更新提案
- [ ] 依存関係 / 影響分析
- [ ] 次アクション（Follow-up Tasks）

## 3. 共通出力フォーマット

### 3.1 機能仕様 (テンプレート)

```
# 機能名
## 概要
## 背景 / 目的
## ユーザーストーリー
- 例: 〜として、〜のために、〜したい
## 前提 / 制約
## フロー概要 (PlantUML)
@startuml
' ここにシーケンス / コンポーネント図
@enduml
## UI / コンポーネント一覧
## 状態 / イベント
## バリデーション要件
## エラーハンドリング方針
## 非機能 (性能 / セキュリティ / アクセシビリティ)
## 開発・テスト観点
## 未決事項
```

### 3.2 ADR (テンプレート)

```
# ADR-<連番>-<短い名前>
## Status (Proposed | Accepted | Deprecated | Superseded by ADR-XX)
## Context
## Decision
## Alternatives
## Consequences (Positive / Negative)
## Follow-up
```

### 3.3 コンポーネント仕様

```
# <ComponentName>
## 目的 / ユースケース
## Props (型 / 必須 / 説明)
## 内部状態 / フック
## アクセシビリティ
## スタイル / トークン
## 依存 (他コンポーネント / hooks / 外部 lib)
## テストケース一覧
## 拡張余地 / 制限
```

### 3.4 Server Action / API

```
# Action 名
## 目的
## 入力スキーマ (Zod)
## 出力スキーマ
## 事前条件 / 事後条件 (契約による設計)
## エラー分類 (ユーザー起因 / システム)
## RLS / セキュリティ考慮
## 例 (呼び出し/レスポンス)
```

### 3.5 DB スキーマ差分

```
# スキーマ変更
## 追加 / 変更 / 削除テーブル
| テーブル | 操作 | 説明 |
## カラム変更
| テーブル | カラム | 変更点 | 影響 |
## インデックス / 制約
## RLS ポリシー
## マイグレーション計画
```

### 3.6 テスト増補

```
# テスト強化
## 対象
## 目的
## 追加すべきケース
| ケースID | 種別 | 条件 | 期待結果 |
## カバレッジ不足領域
## モック戦略
```

### 3.7 リリースノート候補 (50 字以内 + 詳細)

```
feat: <短い概要> (50字以内)

詳細:
- 変更点:
- 影響範囲:
- 移行注意:
```

## 4. 出力時のスタイル

- 箇条書き優先 / 冗長説明回避
- 既存と重複する既知情報は「(既存参照: path/to/file.md#section)」表記
- 未決事項は必ず末尾にセクション化
- 役割語 / 主語の省略（簡潔）

## 5. 実行アルゴリズム

1. 差分要約 → 種別選定
2. 対象テンプレの空欄を埋める
3. 既存ファイルにマージ想定の差分形式で出力（必要ならパスを提案）
4. 未決事項 / 次アクションを列挙
5. コミットメッセージ候補（Conventional Commits + 50 字制約）を提示

## 6. 出力セクション順序（最終）

1. Summary
2. SelectedDocTypes
3. Documents (各種)
4. TasksToAdd / Update
5. CommitMessageCandidate
6. OpenQuestions / Risks
7. FollowUps

## 7. バリデーション

- コード参照がある場合：ファイルパス + シンボル名必須
- 契約による設計: 事前条件 / 事後条件 / 不変条件を API / ロジックに適用
- 型安全: any を導入する提案は禁止

## 8. 例（短縮出力例）

```
Summary:
- ComponentA に props 追加 (loadingState)
SelectedDocTypes: [コンポーネント技術ドキュメント, テスト計画]

<ComponentA ドキュメント> ...
追加テスト: ...
Commit: feat: ComponentAにローディング状態追加
OpenQuestions: skeleton適用範囲
FollowUps: Storybook更新
```

## 9. ライフサイクル（自動管理フロー）

1. 変更取得: git diff / 対象タスク / 差分サマリ
2. 分類: 種別マッピング（コード → 文書種別）
3. 既存参照: 同種文書探索（類似タイトル / パス）
4. 生成: テンプレ空欄を最小充填（推測禁止 / 不足＝質問）
5. 差分統合: 追記・改訂方針 (Append / Amend / Supersede)
6. 整合性検査: 重複・孤立・未リンクチェック
7. インデックス更新: toc / ADR 一覧 / コンポーネント一覧
8. コミット案 + 次アクション列挙

## 10. ディレクトリ標準

```
docs/
  specs/            # 機能仕様
  adr/              # アーキテクチャ決定記録
  components/       # コンポーネント技術文書
  actions/          # Server Action / API仕様
  db/               # スキーマ差分・ER・RLS
  tests/            # テスト計画と増補
  release/          # リリースノート候補
  index/            # 自動生成索引
```

## 11. 命名規則（Doc）

- 機能仕様: `spec-<domain>-<feature>.md`
- ADR: `ADR-<連番>-<短縮英語>.md`
- コンポーネント: `<ComponentName>.md`
- Action: `action-<scope>-<name>.md`
- DB 差分: `schema-diff-YYYYMMDD-<topic>.md`
- テスト: `test-plan-<scope>.md`
- リリースノート: `release-notes-<version>.md`

## 12. 自動分類マッピング例

| 変更種別 | 文書種別 |
| Component props 変化 | コンポーネント仕様 / テスト増補 |
| Server Action 追加 | Action 仕様 / ADR(必要時) |
| スキーマ変更 | DB スキーマ差分 / ADR(破壊的) |
| バリデーション追加 | Feature Spec / Action 仕様 |
| パフォーマンス最適化 | ADR(任意) / リリースノート候補 |

## 13. ガバナンス検査項目

- 未リンクの孤立ファイル数
- ADR Status 不整合
- テンプレ必須節の欠落
- 未決事項が後続チケット化されているか
- バージョンアップに伴うリリースノート存在

## 14. インデックス出力仕様

`docs/index/overview.md` に集約:

- 総件数 / 種別件数
- ADR 一覧（Status 別）
- 未決 / Follow-up 未処理数
- 最新 5 件変更履歴

## 15. 実行モード例

- mode: incremental（差分のみ）
- mode: full-audit（全体整合性）
- mode: index-update（索引のみ）
- mode: verify (構文 / テンプレチェック)

## 16. 質問優先ルール

不明: 曖昧 / 外部依存 / 設計未確定 は質問リスト化
例: `? コンポーネントXの非機能要件（性能指標）は？`

## 17. セキュリティ / RLS 記述最低限

- データ種別分類
- 認可境界
- 入力バリデーション(Zod)参照
- ログ / 監査

## 18. 出力の品質チェック自動質問

- 省略された必須節は？
- 既存文書との重複説明は？
- 新規テストケースは境界値を含むか？
- リスクは追跡可能か？

## 19. 最終出力テンプレ（AI はこの骨子順で必ず整形）

```
Summary:
  - <差分要約箇条書き>

SelectedDocTypes:
  - <選定した文書種別列挙>

Documents:
  ### <DocType1 名称 or ファイルパス案>
  (ここに当該テンプレ充填済み Markdown 本文)
  ---
  ### <DocType2 ...>
  ...

TasksToAddOrUpdate:
  - TASK-XXX: <追加/更新理由 + 粒度(1日以内)>

CommitMessageCandidate:
  <Conventional Prefix + 50字以内日本語要約>

OpenQuestions / Risks:
  - Q1: ...
  - Risk: ...

FollowUps:
  - <次アクション（担当/期限任意）>
  - <必要なら ADR 起票提案>
```

## 20. コミットメッセージ生成ルール（厳守）

- 形式: `<type>: <本文（50字以内日本語）>`
- 利用 type 例: feat / fix / refactor / docs / chore / test / perf / build
- 破壊的変更含む場合: 末尾に `!` を type に付与 (例: `feat!:`)
- 本文 NG: 句読点連続 / 英語不要略語 / 末尾ピリオド
- 併せて「TasksToAddOrUpdate」が存在する場合は本文に触れずドキュメント側で追跡

## 21. 実行サンプル（ダミー）

```
Summary:
  - Component Button に size=lg 追加
  - バリデーション拡張（最小長さ 8）

SelectedDocTypes:
  - コンポーネント技術ドキュメント
  - テスト計画 / 追加テストケース
  - リリースノート候補

Documents:
  ### components/Button.md (差分案)
  - Props テーブルに size 行追加 (値: sm|md|lg, default: md)
  - アクセシビリティ: role=button 変更なし
  - テストケース: size=lg snapshot/キーボード操作

  ### tests/test-plan-auth-password.md (追記案)
  - 追加ケース: 最小8文字未満 -> エラーメッセージ表示

  ### release/preview
  feat: ButtonにlgサイズとPW最小長8を追加

TasksToAddOrUpdate:
  - TASK-112: Storybook に lg variant 追加
  - TASK-113: E2E（フォーム送信最小長検証）追加

CommitMessageCandidate:
  feat: Buttonにlgサイズ追加とPW最小長8適用

OpenQuestions / Risks:
  - Q: size=xl 要望は将来想定？
  - Risk: 既存デザインテーマで lg 行間崩れの可能性

FollowUps:
  - Storybook 更新
  - デザイン側トークン line-height 再確認
```

(利用時注意: 充填不能項目は質問として列挙。推測埋め禁止)
